@page "/register"
@using GRC.Desktop.Blazor.Models
@using GRC.Desktop.Blazor.Services
@using GRC.Desktop.Blazor.Stores
@using GRC.Desktop.Blazor.Helpers
@inject AuthService AuthService
@inject AuthStore AuthStore
@inject NavigationManager Navigation

<div class="auth-container">
    <div class="auth-card auth-card-wide">
        <h1 class="auth-title">GRC Registration</h1>
        
        <div class="form-group-horizontal">
            <label for="orgType" class="form-label-horizontal">Organization Type</label>
            <div class="org-type-group">
                <div class="form-check">
                    <input class="form-check-input" type="radio" id="consultant" 
                           @onchange="@((ChangeEventArgs e) => RegisterModel.OrganizationType = OrganizationType.Consultant)"
                           name="orgType" checked />
                    <label class="form-check-label" for="consultant">Consultant</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" id="clientOrg" 
                           @onchange="@((ChangeEventArgs e) => RegisterModel.OrganizationType = OrganizationType.ClientOrganization)"
                           name="orgType" />
                    <label class="form-check-label" for="clientOrg">Client Organization</label>
                </div>
            </div>
        </div>

        <div class="form-group-horizontal">
            <label for="email" class="form-label-horizontal">Email Address</label>
            <div style="flex: 1;">
                <input type="email" class="form-control" id="email" placeholder="Enter email address"
                       @bind="RegisterModel.EmailAddress" />
                @if (!string.IsNullOrEmpty(EmailError))
                {
                    <small class="text-danger" style="display: block; text-align: left;">@EmailError</small>
                }
            </div>
        </div>

        <div class="form-group-horizontal">
            <label for="password" class="form-label-horizontal">Password</label>
            <div style="flex: 1;">
                <input type="password" class="form-control" id="password" placeholder="Enter password"
                       @bind="RegisterModel.Password" @onblur="ValidatePassword" />
                <small class="hint-text">Hint: Min 8 chars, 1 uppercase, lowercase, digit, special character</small>
                @if (!string.IsNullOrEmpty(PasswordStrengthError))
                {
                    <small class="text-danger" style="display: block; text-align: left;">@PasswordStrengthError</small>
                }
            </div>
        </div>

        <div class="form-group-horizontal">
            <label for="confirmPassword" class="form-label-horizontal">Confirm Password</label>
            <div style="flex: 1;">
                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm password"
                       @bind="RegisterModel.ConfirmPassword" @onblur="ValidateConfirmPassword" />
                <small class="hint-text">Hint: Must match the password above</small>
                @if (!string.IsNullOrEmpty(PasswordError))
                {
                    <small class="text-danger" style="display: block; text-align: left;">@PasswordError</small>
                }
            </div>
        </div>

        <div class="form-group-horizontal">
            <label for="roleType" class="form-label-horizontal">Role Type</label>
            <select class="form-select" id="roleType" @bind="RegisterModel.RoleType">
                <option value="@RoleType.ManagementApprover">Register as Management â€“ Approver (2 approvers)</option>
                <option value="@RoleType.SuperAdmin">Create Super Admin</option>
                <option value="@RoleType.Admin">Create Admin</option>
                <option value="@RoleType.Approver">Create Approver</option>
                <option value="@RoleType.CheckerReviewer">Create Checker / Reviewer</option>
                <option value="@RoleType.Maker">Create Maker</option>
                <option value="@RoleType.ProcessOwner">Create Process Owner</option>
                <option value="@RoleType.ControlOwner">Create Control Owner</option>
                <option value="@RoleType.RiskOwner">Create Risk Owner</option>
            </select>
        </div>

        <div class="form-group-horizontal">
            <label for="mobile" class="form-label-horizontal">Mobile Number</label>
            <div style="flex: 1;">
                <div class="input-group">
                    <select class="form-select" id="countryCode" value="@RegisterModel.CountryCode" @onchange="OnCountryCodeChanged" style="max-width: 200px;">
                        <option value="">-- Select Country --</option>
                        @foreach (var country in Countries)
                        {
                            <option value="@country.Key">@country.Value (+@country.Key)</option>
                        }
                    </select>
                    <input type="tel" class="form-control" id="mobile" placeholder="Enter mobile number (7-15 digits)"
                           @bind="RegisterModel.MobileNumber" @onblur="ValidateMobileNumber" inputmode="numeric" />
                </div>
                @if (!string.IsNullOrEmpty(CountryCodeError))
                {
                    <small class="text-danger" style="display: block; text-align: left;">@CountryCodeError</small>
                }
                @if (!string.IsNullOrEmpty(MobileError))
                {
                    <small class="text-danger" style="display: block; text-align: left;">@MobileError</small>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @ErrorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="alert alert-success" role="alert">
                @SuccessMessage
            </div>
        }

        <div class="button-group">
            <button class="btn btn-primary" @onclick="HandleRegister" disabled="@IsLoading">
                @if (IsLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Registering...</span>
                }
                else
                {
                    <span>Register</span>
                }
            </button>
            <button class="btn btn-secondary" @onclick="HandleClear" disabled="@IsLoading">Clear</button>
        </div>

        <div class="form-footer">
            <p>Already have an account? <a href="/login">Login here</a></p>
        </div>
    </div>
</div>

@code {
    private RegisterRequest RegisterModel = new() 
    { 
        OrganizationType = OrganizationType.Consultant 
    };
    
    private Dictionary<string, string> Countries = new();
    
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;
    private string EmailError = string.Empty;
    private string PasswordStrengthError = string.Empty;
    private string PasswordError = string.Empty;
    private string CountryCodeError = string.Empty;
    private string MobileError = string.Empty;
    private bool IsLoading = false;

    protected override void OnInitialized()
    {
        Countries = MobileNumberValidationHelper.GetSupportedCountries();
    }

    private async Task HandleRegister()
    {
        // Clear all errors
        EmailError = string.Empty;
        PasswordStrengthError = string.Empty;
        PasswordError = string.Empty;
        CountryCodeError = string.Empty;
        MobileError = string.Empty;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(RegisterModel.EmailAddress))
        {
            EmailError = "Email address is required";
            return;
        }

        if (!RegisterModel.EmailAddress.Contains("@"))
        {
            EmailError = "Please enter a valid email address";
            return;
        }

        // Validate password strength
        var passwordValidation = PasswordValidationHelper.ValidatePasswordStrength(RegisterModel.Password);
        if (!passwordValidation.IsValid)
        {
            PasswordStrengthError = passwordValidation.ErrorMessage;
            return;
        }

        // Validate confirm password
        var confirmValidation = PasswordValidationHelper.ValidateConfirmPassword(RegisterModel.Password, RegisterModel.ConfirmPassword);
        if (!confirmValidation.IsValid)
        {
            PasswordError = confirmValidation.ErrorMessage;
            return;
        }

        // Validate mobile number
        var mobileValidation = MobileNumberValidationHelper.ValidateMobileNumber(RegisterModel.MobileNumber, RegisterModel.CountryCode);
        if (!mobileValidation.IsValid)
        {
            MobileError = mobileValidation.ErrorMessage;
            return;
        }

        IsLoading = true;

        try
        {
            var result = await AuthService.RegisterAsync(RegisterModel);
            
            if (result.Success)
            {
                SuccessMessage = "Registration successful! Redirecting to login...";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                ErrorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ValidatePassword()
    {
        var validation = PasswordValidationHelper.ValidatePasswordStrength(RegisterModel.Password);
        PasswordStrengthError = validation.IsValid ? string.Empty : validation.ErrorMessage;
    }

    private void ValidateConfirmPassword()
    {
        var validation = PasswordValidationHelper.ValidateConfirmPassword(RegisterModel.Password, RegisterModel.ConfirmPassword);
        PasswordError = validation.IsValid ? string.Empty : validation.ErrorMessage;
    }

    private void OnCountryCodeChanged(ChangeEventArgs e)
    {
        CountryCodeError = string.Empty;
        RegisterModel.CountryCode = e.Value?.ToString() ?? string.Empty;
    }

    private void ValidateMobileNumber()
    {
        MobileError = string.Empty;
        if (string.IsNullOrWhiteSpace(RegisterModel.MobileNumber))
        {
            MobileError = "Mobile number is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(RegisterModel.CountryCode))
        {
            CountryCodeError = "Please select a country.";
            return;
        }

        var validation = MobileNumberValidationHelper.ValidateMobileNumber(RegisterModel.MobileNumber, RegisterModel.CountryCode);
        if (!validation.IsValid)
        {
            MobileError = validation.ErrorMessage;
        }
    }

    private void HandleClear()
    {
        RegisterModel = new() 
        { 
            OrganizationType = OrganizationType.Consultant 
        };
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        EmailError = string.Empty;
        PasswordStrengthError = string.Empty;
        PasswordError = string.Empty;
        CountryCodeError = string.Empty;
        MobileError = string.Empty;
    }
}
